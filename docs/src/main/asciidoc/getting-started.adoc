[[getting-started]]
= Getting Started

include::_attributes.adoc[]

If you are getting started with {project-full-name}, start by reading this section.
It answers the basic "`what?`", "`how?`" and "`why?`" questions.
It includes an introduction to {project-full-name}, along with installation instructions.


[[getting-started-introducing-datasource-micrometer]]
== Introducing Datasource Micrometer

The Datasource Micrometer provides {micrometer-observation}[Micrometer Observation API] instrumentation for JDBC operations.

It provides consistent observability for JDBC-based data access by
instrumenting common database interactions such as:

* Connection acquisition and release
* Query execution
* Result set fetching
* Generated key retrieval

Datasource Micrometer integrates naturally with the Micrometer ecosystem and can emit metrics and spans to a variety of monitoring and tracing backends.

The instrumentation implementation uses https://github.com/ttddyy/datasource-proxy[datasource-proxy] to provide a proxy for JDBC operations.

[[getting-started-intro-background]]
=== Background

The Micrometer v1.10.0 introduced the new {micrometer-observation}[Observation API] and {micrometer-tracing}[Micrometer Tracing] module.
The {micrometer-observation}[Observation API] allows measuring(observing) any interested behavior from the code in action. Then, notifies it to the registered handlers.
The {micrometer-tracing}[Micrometer Tracing] module provides an observation handler implementation that creates distributed traces(spans). It uses a tracer that has abstracted the popular tracer implementations and gives the vendor free APIs for tracing.

In Spring Boot 2.x, the {spring-cloud-sleuth}[Spring Cloud Sleuth] provided the instrumentation to the many components including JDBC operations.
It was a central library that provides tracing instrumentation to the Spring Boot applications.
However, with the new observability, the responsibility for instrumentation has shifted to the individual component.
For example, Spring Framework will provide native instrumentation support for its components using the {micrometer-observation}[Observation API].
As a result, there will be no {spring-cloud-sleuth}[Spring Cloud Sleuth] for Spring Boot 3.

This Datasource Micrometer project provides instrumentation on the JDBC operations to cover what was provided by the {spring-cloud-sleuth}[Spring Cloud Sleuth] but with the {micrometer-observation}[Observation API].
The initial version aims users to smoothly transition from Spring Boot 2.x with Spring Cloud Sleuth to the Spring Boot 3 in JDBC instrumentation.
In addition, since the {micrometer-observation}[Observation API] and {micrometer-tracing}[Micrometer Tracing] are independent from Spring ecosystem, the instrumentation is available to the non-spring applications as well.

[[getting-started-intro-modules]]
=== Modules
Datasource Micrometer is composed of several modules that can be combined depending on your observability needs.

==== datasource-micrometer
The core module provides JDBC instrumentation using Micrometer Observation.

If you are a {micrometer}[Micrometer] user but not using Spring Boot, you can directly use the `datasource-micrometer` module, which does not have a dependency on the Spring.

==== datasource-micrometer-opentelemetry
The `datasource-micrometer-opentelemetry` module maps JDBC observations produced by Datasource Micrometer to the stable parts of OpenTelemetry Semantic Conventions.

This module uses https://github.com/JSQLParser/JSqlParser[JSqlParser] to analyze queries.

It focuses on query execution, which is the only JDBC interaction currently covered by OpenTelemetry Semantic Conventions.

==== datasource-micrometer-spring-boot
The Spring Boot module provides auto-configuration for Datasource Micrometer.

When present on the classpath, it:

* Automatically instruments `DataSource` beans
* Registers default observation conventions
* Integrates with Spring Bootâ€™s Micrometer and Observation infrastructure

In addition, when the `datasource-micrometer-opentelemetry` module is available on the classpath, OpenTelemetry support is automatically enabled via auto-configuration.

This is the recommended entry point for most Spring Boot applications.

==== datasource-micrometer-bom
The `datasource-micrometer-bom` module provides a Bill of Materials (BOM) for Datasource Micrometer modules.

It can be used to manage consistent dependency versions across Datasource Micrometer artifacts.

=== Choosing the Right Setup
The following summarizes common usage scenarios:

* Use `datasource-micrometer` if you want low-level JDBC observations without Spring Boot.
* Use `datasource-micrometer-spring-boot` for standard Micrometer-based observability in Spring Boot applications.
* Add `datasource-micrometer-opentelemetry` if you want JDBC spans and metrics to follow OpenTelemetry Semantic Conventions.


[[getting-started-installation]]
== Installation

[[getting-started-installation-maven-and-gradle]]
=== Maven and Gradle
*datasource-micrometer*

====
[source,xml,indent=0,subs="verbatim,attributes",role="primary"]
.Maven
----
    <dependency>
        <groupId>net.ttddyy.observation</groupId>
        <artifactId>datasource-micrometer</artifactId>
        <version>{project-version}</version>
    </dependency>
----

[source,groovy,indent=0,subs="verbatim,attributes",role="secondary"]
.Gradle
----
dependencies {
    implementation "net.ttddyy.observation:datasource-micrometer:{project-version}"
}
----
====

*datasource-micrometer-opentelemetry*
====
[source,xml,indent=0,subs="verbatim,attributes",role="primary"]
.Maven
----
    <dependency>
        <groupId>net.ttddyy.observation</groupId>
        <artifactId>datasource-micrometer-opentelemetry</artifactId>
        <version>{project-version}</version>
    </dependency>
----

[source,groovy,indent=0,subs="verbatim,attributes",role="secondary"]
.Gradle
----
dependencies {
    implementation "net.ttddyy.observation:datasource-micrometer-opentelemetry:{project-version}"
}
----
====

*datasource-micrometer-spring-boot*

====
[source,xml,indent=0,subs="verbatim,attributes",role="primary"]
.Maven
----
    <dependency>
        <groupId>net.ttddyy.observation</groupId>
        <artifactId>datasource-micrometer-spring-boot</artifactId>
        <version>{project-version}</version>
    </dependency>
----

[source,groovy,indent=0,subs="verbatim,attributes",role="secondary"]
.Gradle
----
dependencies {
    implementation "net.ttddyy.observation:datasource-micrometer-spring-boot:{project-version}"
}
----
====

*datasource-micrometer-bom*

====
[source,xml,indent=0,subs="verbatim,attributes",role="primary"]
.Maven
----
	<dependencyManagement>
		<dependencies>
			<dependency>
				<groupId>net.ttddyy.observation</groupId>
				<artifactId>datasource-micrometer-bom</artifactId>
				<version>{project-version}</version>
				<type>pom</type>
				<scope>import</scope>
			</dependency>
		</dependencies>
	</dependencyManagement>
----

[source,groovy,indent=0,subs="verbatim,attributes",role="secondary"]
.Gradle
----
dependencies {
    implementation platform("net.ttddyy.observation:datasource-micrometer-bom:{project-version}")
}
----
====

[[getting-started-installation-setup]]
=== Setup

*datasource-micrometer*

To setup the observation for JDBC operations, xref:howto.adoc#how-to-instrument-datasource[create a proxy of your DataSource], then xref:howto.adoc#how-to-add-tracingobservationhandler[register the corresponding tracing observation handlers].

[source,java,indent=0]
----
// Register the tracing observation handlers
ObservationRegistry observationRegistry = ObservationRegistry.create();
ObservationConfig observationConfig = observationRegistry.observationConfig();
observationConfig.observationHandler(new ConnectionTracingObservationHandler(tracer));
observationConfig.observationHandler(new QueryTracingObservationHandler(tracer));
observationConfig.observationHandler(new ResultSetTracingObservationHandler(tracer));
//  add other necessary handlers

// Create a DataSource proxy with the observation listener
DataSource dataSource = ...
DataSourceObservationListener listener = new DataSourceObservationListener(observationRegistry);
DataSource instrumented = ProxyDataSourceBuilder.create(dataSource).listener(listener).methodListener(listener).build;

// Use the instrumented DataSource
----

*datasource-micrometer-spring-boot*

The auto-configuration class automatically sets up the observation on your `DataSource` bean.

[[getting-started-migration-from-spring-cloud-sleuth]]
== Migration from Spring Cloud Sleuth

Datasource Micrometer deliberately provides similar property names to ease the migration from {spring-cloud-sleuth}[Spring Cloud Sleuth].
Most of the JDBC related properties from `spring.sleuth.jdbc` and `spring.sleuth.jdbc.datasource-proxy` map to the `jdbc` and `jdbc.datasource-proxy` properties.

Please reference the list of application properties in https://docs.spring.io/spring-cloud-sleuth/docs/current/reference/html/appendix.html#common-application-properties[Spring Cloud Sleuth] and xref:appendix.adoc#appendix-common-application-properties[Datasource Micrometer].
